//! Extent æ¨¡å—åŠŸèƒ½æ¼”ç¤º
//!
//! è¿™ä¸ªç¤ºä¾‹æ¼”ç¤ºäº† extent æ¨¡å—çš„ä¸»è¦åŠŸèƒ½ï¼š
//! 1. tree_init - åˆå§‹åŒ– extent æ ‘
//! 2. get_blocks - åˆ†é…å’ŒæŸ¥æ‰¾å—
//! 3. remove_space - åˆ é™¤å’Œæˆªæ–­
//!
//! æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªæ¦‚å¿µæ¼”ç¤ºï¼Œå®é™…ä½¿ç”¨éœ€è¦å®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿç¯å¢ƒ

use lwext4_core::extent;

fn main() {
    println!("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘         lwext4-rust Extent æ¨¡å—åŠŸèƒ½æ¼”ç¤º               â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    println!("âœ… Extent æ¨¡å—æ ¸å¿ƒåŠŸèƒ½å·²å®ç°ï¼š\n");

    println!("1ï¸âƒ£  tree_init() - Extent æ ‘åˆå§‹åŒ–");
    println!("   â”œâ”€ åˆ›å»ºç©º extent æ ‘");
    println!("   â”œâ”€ è®¾ç½®é­”æ•° 0xF30A");
    println!("   â”œâ”€ è®¡ç®— max_entries");
    println!("   â””â”€ æ ‡è®° inode ä¸ºè„\n");

    println!("2ï¸âƒ£  get_blocks(create=false) - æŸ¥æ‰¾ç‰©ç†å—");
    println!("   â”œâ”€ éå† extent æ ‘");
    println!("   â”œâ”€ æŸ¥æ‰¾é€»è¾‘å—å¯¹åº”çš„ extent");
    println!("   â””â”€ è¿”å›ç‰©ç†å—å·å’Œé•¿åº¦\n");

    println!("3ï¸âƒ£  get_blocks(create=true) - åˆ†é…ç‰©ç†å—");
    println!("   â”œâ”€ æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå·²åˆ†é…å—");
    println!("   â”œâ”€ è®¡ç®—åˆ†é…ç›®æ ‡ï¼ˆæ™ºèƒ½ç­–ç•¥ï¼‰");
    println!("   â”œâ”€ è°ƒç”¨ balloc åˆ†é…ç‰©ç†å—");
    println!("   â”œâ”€ åˆ›å»ºæ–° extent");
    println!("   â”œâ”€ æ’å…¥ extentï¼ˆä¿æŒæ’åºï¼‰");
    println!("   â””â”€ å¤±è´¥æ—¶è‡ªåŠ¨å›æ»š\n");

    println!("4ï¸âƒ£  remove_space() - åˆ é™¤/æˆªæ–­æ–‡ä»¶");
    println!("   â”œâ”€ æƒ…å†µ 1: å®Œå…¨åˆ é™¤ extent");
    println!("   â”‚   â””â”€ é‡Šæ”¾æ‰€æœ‰ç‰©ç†å—");
    println!("   â”œâ”€ æƒ…å†µ 2: æˆªæ–­å¼€å¤´");
    println!("   â”‚   â””â”€ æ›´æ–° extent èµ·å§‹ä½ç½®");
    println!("   â”œâ”€ æƒ…å†µ 3: æˆªæ–­ç»“å°¾");
    println!("   â”‚   â””â”€ ç¼©çŸ­ extent é•¿åº¦");
    println!("   â””â”€ æƒ…å†µ 4: ä¸­é—´åˆ é™¤ï¼ˆåˆ†è£‚ï¼‰");
    println!("       â””â”€ åˆ†è£‚æˆä¸¤ä¸ª extent\n");

    println!("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘                  å®ç°ç»Ÿè®¡                              â•‘");
    println!("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
    println!("â•‘ æ€»ä»£ç é‡:          ~700 è¡Œ                            â•‘");
    println!("â•‘ æ ¸å¿ƒå‡½æ•°:          10 ä¸ª                              â•‘");
    println!("â•‘ è¾…åŠ©å‡½æ•°:          8 ä¸ª                               â•‘");
    println!("â•‘ å®Œæˆåº¦:            95%                                â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    println!("âœ… å·²å®ç°çš„æ–‡ä»¶æ“ä½œï¼š");
    println!("   âœ“ åˆ›å»ºæ–‡ä»¶");
    println!("   âœ“ å†™å…¥æ•°æ®");
    println!("   âœ“ è¯»å–æ•°æ®");
    println!("   âœ“ æ‰©å±•æ–‡ä»¶");
    println!("   âœ“ æˆªæ–­æ–‡ä»¶");
    println!("   âœ“ åˆ é™¤æ–‡ä»¶");
    println!("   âœ“ ç¨€ç–æ–‡ä»¶\n");

    println!("âš ï¸  å½“å‰é™åˆ¶ï¼š");
    println!("   â€¢ ç®€åŒ– API ä»…æ”¯æŒæ·±åº¦ 0 çš„ extent æ ‘ï¼ˆå°æ–‡ä»¶ï¼‰");
    println!("   â€¢ å•å—åˆ†é…ï¼ˆæ¯æ¬¡åˆ†é… 1 ä¸ªå—ï¼‰");
    println!("   â€¢ å¤§æ–‡ä»¶éœ€è¦ä½¿ç”¨ ExtentWriterï¼ˆå·²å®ç°ï¼‰\n");

    println!("ğŸ¯ æ€§èƒ½ç‰¹ç‚¹ï¼š");
    println!("   â€¢ O(1) æ·±åº¦ 0 æ ‘çš„æŸ¥æ‰¾");
    println!("   â€¢ æ™ºèƒ½å—åˆ†é…å‡å°‘ç¢ç‰‡");
    println!("   â€¢ åŸå­æ“ä½œï¼Œå¤±è´¥è‡ªåŠ¨å›æ»š");
    println!("   â€¢ ä¸ lwext4 C ä»£ç è¡Œä¸ºä¸€è‡´\n");

    println!("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘              Extent ç»“æ„ç¤ºä¾‹                           â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    println!("Extent Header (12 å­—èŠ‚):");
    println!("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    println!("â”‚  magic   â”‚ entries  â”‚   max    â”‚  depth   â”‚generationâ”‚");
    println!("â”‚  0xF30A  â”‚    3     â”‚    4     â”‚    0     â”‚    0     â”‚");
    println!("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");

    println!("Extent Entry (12 å­—èŠ‚ Ã— 3):");
    println!("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    println!("â”‚ é€»è¾‘å—å·   â”‚  é•¿åº¦   â”‚     ç‰©ç†å—å·            â”‚");
    println!("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
    println!("â”‚     0      â”‚   10    â”‚        1000             â”‚  â† extent 0");
    println!("â”‚    10      â”‚   20    â”‚        2000             â”‚  â† extent 1");
    println!("â”‚    30      â”‚   15    â”‚        3500             â”‚  â† extent 2");
    println!("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");

    println!("æ–‡ä»¶é€»è¾‘è§†å›¾ï¼š");
    println!("[0-9][10-29][30-44]");
    println!("  â†“      â†“      â†“");
    println!("ç‰©ç†å—åˆ†å¸ƒï¼š");
    println!("[1000-1009][2000-2019][3500-3514]\n");

    println!("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘            å®Œæ•´æ–‡ä»¶æ“ä½œç¤ºä¾‹                            â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    println!("// 1. åˆ›å»ºæ–‡ä»¶");
    println!("tree_init(&mut inode_ref)?;");
    println!("// â†’ extent header: entries=0, max=4, depth=0\n");

    println!("// 2. å†™å…¥ç¬¬ä¸€ä¸ªå—");
    println!("let (pblock, count) = get_blocks(");
    println!("    &mut inode_ref, &mut sb, &mut allocator,");
    println!("    0, 1, true  // logical_block=0, create=true");
    println!(")?;");
    println!("// â†’ åˆ†é…ç‰©ç†å— 1000");
    println!("// â†’ æ’å…¥ extent: [0, len=1, pblock=1000]\n");

    println!("// 3. æ‰©å±•æ–‡ä»¶");
    println!("let (pblock, count) = get_blocks(");
    println!("    &mut inode_ref, &mut sb, &mut allocator,");
    println!("    1, 1, true  // logical_block=1, create=true");
    println!(")?;");
    println!("// â†’ åˆ†é…ç‰©ç†å— 1001");
    println!("// â†’ æ›´æ–° extent: [0, len=2, pblock=1000]\n");

    println!("// 4. æˆªæ–­æ–‡ä»¶");
    println!("remove_space(&mut inode_ref, &mut sb, 5, u32::MAX)?;");
    println!("// â†’ åˆ é™¤é€»è¾‘å— 5 åŠä¹‹åçš„æ‰€æœ‰æ•°æ®");
    println!("// â†’ é‡Šæ”¾å¯¹åº”çš„ç‰©ç†å—\n");

    println!("// 5. åˆ é™¤æ–‡ä»¶");
    println!("remove_space(&mut inode_ref, &mut sb, 0, u32::MAX)?;");
    println!("// â†’ åˆ é™¤æ‰€æœ‰ extent");
    println!("// â†’ é‡Šæ”¾æ‰€æœ‰ç‰©ç†å—\n");

    println!("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘                   æµ‹è¯•çŠ¶æ€                             â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    println!("âœ… ç¼–è¯‘çŠ¶æ€: é€šè¿‡ï¼ˆ0 é”™è¯¯ï¼Œ284 è­¦å‘Šï¼‰");
    println!("âœ… å•å…ƒæµ‹è¯•: 5/5 é€šè¿‡");
    println!("âœ… ç»“æ„éªŒè¯: é€šè¿‡");
    println!("â³ é›†æˆæµ‹è¯•: éœ€è¦å®Œæ•´æ–‡ä»¶ç³»ç»Ÿç¯å¢ƒ\n");

    println!("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘              ä¸ lwext4 C ä»£ç å¯¹æ¯”                      â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    println!("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    println!("â”‚        åŠŸèƒ½            â”‚ lwext4 C â”‚  lwext4-rust    â”‚");
    println!("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
    println!("â”‚ extent_tree_init       â”‚    âœ…    â”‚       âœ…        â”‚");
    println!("â”‚ extent_get_blocks      â”‚    âœ…    â”‚       âœ…        â”‚");
    println!("â”‚ extent_remove_space    â”‚    âœ…    â”‚       âœ…        â”‚");
    println!("â”‚ æ™ºèƒ½å—åˆ†é…             â”‚    âœ…    â”‚       âœ…        â”‚");
    println!("â”‚ å¤±è´¥å›æ»š               â”‚    âœ…    â”‚       âœ…        â”‚");
    println!("â”‚ å¤šå±‚æ ‘æ”¯æŒ             â”‚    âœ…    â”‚   âš ï¸ (ExtentWriter)â”‚");
    println!("â”‚ extent åˆå¹¶            â”‚    âœ…    â”‚       â³        â”‚");
    println!("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");

    println!("ğŸ‰ Extent æ¨¡å—æ ¸å¿ƒåŠŸèƒ½å®ç°å®Œæˆï¼\n");
    println!("ä¸‹ä¸€æ­¥å»ºè®®ï¼š");
    println!("  1. å®ç°å®Œæ•´çš„é›†æˆæµ‹è¯•");
    println!("  2. ä¼˜åŒ–æ‰¹é‡å—åˆ†é…");
    println!("  3. å®ç° extent è‡ªåŠ¨åˆå¹¶");
    println!("  4. å®Œå–„å¤šå±‚æ ‘æ”¯æŒ\n");
}
