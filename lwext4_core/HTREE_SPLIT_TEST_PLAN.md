# HTree 分裂功能测试计划

## 概述

本文档描述了如何测试和验证 lwext4-rust 中实现的 HTree 分裂功能。

## 实现状态

### ✅ 已完成的功能

1. **叶子块分裂** (`htree::split_leaf_block`)
   - 读取并排序目录项
   - 计算分裂点（50% 容量）
   - 处理哈希碰撞
   - 分配新块并写入数据
   - 返回分裂哈希值

2. **索引块分裂** (`htree::split_index_block`)
   - 非根索引块的 1:1 分裂
   - 根索引块分裂（树高度增长）
   - 索引条目重新分配

3. **分裂逻辑集成** (`write::add_entry_htree`)
   - 路径追踪（`get_leaf_with_path`）
   - 叶子块满时自动分裂
   - 分裂后重试插入
   - 索引条目自动插入

### ⚠️ 部分限制

1. **递归索引分裂**：当索引块也满时，暂不支持递归分裂（返回错误）
2. **根节点直接分裂**：功能已实现但未完全集成到 add_entry 流程

## 测试策略

### 1. 单元测试（已完成）

基础的 BlockDevice 测试已通过：
- ✅ Block device 创建
- ✅ Block 读写
- ✅ 字节级读取
- ✅ 统计信息

### 2. 功能测试（需要完整文件系统支持）

以下测试需要完整的文件系统挂载功能：

#### 测试场景 A: 基本叶子块分裂

**前置条件**：
- 创建一个启用 HTree 索引的目录
- 目录初始只有一个数据块

**测试步骤**：
1. 向目录添加文件，直到第一个数据块接近满（约 100 个条目，取决于块大小）
2. 添加触发分裂的文件
3. 验证分裂结果：
   - 原始块和新块都存在
   - 所有文件都能找到
   - HTree 索引正确更新
   - 新增了一个索引条目

**预期结果**：
- 分裂成功
- 新文件成功插入
- 目录结构完整

#### 测试场景 B: 多次叶子块分裂

**前置条件**：
- 测试场景 A 的结果

**测试步骤**：
1. 继续添加文件，触发更多分裂
2. 验证 HTree 索引增长正确
3. 检查所有文件仍然可访问

**预期结果**：
- 多次分裂成功
- HTree 深度保持为 1（非根索引层）
- 所有文件可访问

#### 测试场景 C: 索引块分裂

**前置条件**：
- 大量叶子块（>100 个，取决于块大小）
- 索引块接近满

**测试步骤**：
1. 添加文件直到索引块满
2. 触发索引块分裂
3. 验证：
   - 索引块正确分裂
   - HTree 深度增加（如果是根分裂）
   - 所有文件仍可访问

**预期结果**：
- 索引块分裂成功
- 树结构正确

### 3. 压力测试

**测试步骤**：
1. 创建包含 10,000+ 文件的大目录
2. 验证所有文件都能正确找到
3. 测量查找性能（应该是 O(log n)）

**预期结果**：
- 所有操作成功
- 性能符合预期

### 4. 边界情况测试

1. **哈希碰撞**：
   - 创建具有相同哈希值的文件名
   - 验证它们在分裂后保持在同一块

2. **分裂点在碰撞组内**：
   - 验证 continued 标志正确设置
   - 验证所有碰撞条目保持在一起

3. **块大小边界**：
   - 测试不同的块大小（1KB, 2KB, 4KB）
   - 验证分裂逻辑在各种块大小下正常工作

## 当前测试限制

由于以下功能尚未完全实现，某些测试暂时无法执行：

1. **文件系统挂载**：需要完整的挂载/卸载功能
2. **目录创建**：需要 inode 分配和目录初始化
3. **文件创建**：需要完整的文件系统写入路径

## 手动验证方法

在完整的集成测试可用之前，可以通过以下方式手动验证：

### 1. 代码审查

- ✅ 与 lwext4 C 代码逐行对比
- ✅ 验证算法正确性
- ✅ 检查边界条件处理

### 2. 静态分析

```bash
# 编译检查
cargo check

# 格式检查
cargo fmt --check

# Clippy 检查
cargo clippy
```

### 3. 单元测试

```bash
# 运行所有测试
cargo test

# 运行集成测试
cargo test --test integration_test
```

### 4. 使用外部工具验证

创建测试镜像后，可以使用以下工具验证：

```bash
# 检查文件系统完整性
e2fsck -fn test.ext4

# 查看目录结构
debugfs test.ext4 -R "htree /test_dir"

# 验证所有文件可访问
find /mnt/test -type f | wc -l
```

## 未来工作

1. **完善集成测试**：
   - 实现完整的文件系统挂载功能
   - 添加目录和文件创建 API
   - 创建自动化测试套件

2. **性能测试**：
   - 基准测试：查找性能
   - 基准测试：插入性能
   - 与 lwext4 C 版本对比

3. **模糊测试**：
   - 随机文件名生成
   - 随机操作序列
   - 边界条件探测

## 测试检查清单

- [x] 编译无错误
- [x] 基本 BlockDevice 测试通过
- [x] 代码与 lwext4 C 版本对比
- [ ] 叶子块分裂集成测试
- [ ] 索引块分裂集成测试
- [ ] 大规模目录测试
- [ ] 性能基准测试
- [ ] 与 e2fsck 验证兼容性

## 结论

HTree 分裂功能的核心算法已经实现并通过编译。完整的集成测试需要等待文件系统挂载和完整写入路径的实现。

当前实现已经为未来的集成测试做好准备，代码结构清晰，与 lwext4 C 版本保持一致。
